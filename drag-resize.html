<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../polymer/lib/mixins/gesture-event-listeners.html">
<link rel="import" href="../polymer/lib/utils/flattened-nodes-observer.html">
<link rel="import" href="../iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../shadycss/apply-shim.html">
<!--
  CSS custom property | Description | Default
  ------------------- | ----------- | -------
  `--drag-resize-handle-size` | draggable edge/corner size | 8px;
  `--drag-resize-edge-border` | border for resizable edges | '';
  `--drag-resize-corner-border` | border for resizable corners | '';
  `--drag-resize-container` | Mixin applied to resize container | {};
  `--drag-resize-top-cursor` | top cursor | ns-resize;
  `--drag-resize-bottom-cursor` | bottom cursor | ns-resize;
  `--drag-resize-left-cursor` | left cursor | ew-resize;
  `--drag-resize-right-cursor` | right cursor | ew-resize;
  `--drag-resize-top-left-cursor` | top-left cursor | nw-resize;
  `--drag-resize-top-right-cursor` | top-right cursor | ne-resize;
  `--drag-resize-bottom-left-cursor` | bottom-left cursor | sw-resize;
  `--drag-resize-bottom-right-cursor` | bottom-right cursor | se-resize;
-->
<dom-module id="drag-resize">
  <template strip-whitespace>
    <style>
      :host {
        display: inline-block;
        --drag-resize-handle-size: 8px;
        --drag-resize-top-cursor: ns-resize;
        --drag-resize-bottom-cursor: ns-resize;
        --drag-resize-left-cursor: ew-resize;
        --drag-resize-right-cursor: ew-resize;
        --drag-resize-top-left-cursor: nw-resize;
        --drag-resize-top-right-cursor: ne-resize;
        --drag-resize-bottom-left-cursor: sw-resize;
        --drag-resize-bottom-right-cursor: se-resize;
      }
      #container {
        position: relative;
        box-sizing: border-box;
        @apply --drag-resize-container;
      }
      #fit {
        position: absolute;
        top: 0;
        left: 0;
        bottom: 0;
        right: 0;
      }
      #top {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        border-top: var(--drag-resize-edge-border);
        height: var(--drag-resize-handle-size);
        cursor: var(--drag-resize-top-cursor);
      }
      #right {
        position: absolute;
        top: 0;
        right: 0;
        bottom: 0;
        border-right: var(--drag-resize-edge-border);
        width: var(--drag-resize-handle-size);
        cursor: var(--drag-resize-right-cursor);
      }
      #bottom {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        border-bottom: var(--drag-resize-edge-border);
        height: var(--drag-resize-handle-size);
        cursor: var(--drag-resize-bottom-cursor);
      }
      #left {
        position: absolute;
        top: 0;
        left: 0;
        bottom: 0;
        border-left: var(--drag-resize-edge-border);
        width: var(--drag-resize-handle-size);
        cursor: var(--drag-resize-left-cursor);
      }

      #topLeft {
        position: absolute;
        top: calc(var(--drag-resize-handle-size) / -2);
        left: calc(var(--drag-resize-handle-size) / -2);
        width: var(--drag-resize-handle-size);
        height: var(--drag-resize-handle-size);
        cursor: var(--drag-resize-top-left-cursor);
        border-top: var(--drag-resize-corner-border);
        border-left: var(--drag-resize-corner-border);
      }
      #topRight {
        position: absolute;
        top: calc(var(--drag-resize-handle-size) / -2);
        right: calc(var(--drag-resize-handle-size) / -2);
        width: var(--drag-resize-handle-size);
        height: var(--drag-resize-handle-size);
        cursor: var(--drag-resize-top-right-cursor);
        border-top: var(--drag-resize-corner-border);
        border-right: var(--drag-resize-corner-border);
      }
      #bottomLeft {
        position: absolute;
        bottom: calc(var(--drag-resize-handle-size) / -2);
        left: calc(var(--drag-resize-handle-size) / -2);
        width: var(--drag-resize-handle-size, 5px);
        height: var(--drag-resize-handle-size, 5px);
        cursor: var(--drag-resize-bottom-left-cursor);
        border-bottom: var(--drag-resize-corner-border);
        border-left: var(--drag-resize-corner-border);
      }
      #bottomRight {
        position: absolute;
        bottom: calc(var(--drag-resize-handle-size) / -2);
        right: calc(var(--drag-resize-handle-size) / -2);
        width: var(--drag-resize-handle-size);
        height: var(--drag-resize-handle-size);
        cursor: var(--drag-resize-bottom-right-cursor);
        border-bottom: var(--drag-resize-corner-border);
        border-right: var(--drag-resize-corner-border);
      }
    </style>
    <div id="container">
      <slot></slot>
      <div id="fit">
        <div id="top" draggable hidden$="[[!top]]" on-track="_onTrack"></div>
        <div id="right" draggable hidden$="[[!right]]" on-track="_onTrack"></div>
        <div id="bottom" draggable hidden$="[[!bottom]]" on-track="_onTrack"></div>
        <div id="left" draggable hidden$="[[!left]]" on-track="_onTrack"></div>
        <div id="topLeft" draggable hidden$="[[!topLeft]]" on-track="_onTrack"></div>
        <div id="topRight" draggable hidden$="[[!topRight]]" on-track="_onTrack"></div>
        <div id="bottomLeft" draggable hidden$="[[!bottomLeft]]" on-track="_onTrack"></div>
        <div id="bottomRight" draggable hidden$="[[!bottomRight]]" on-track="_onTrack"></div>
      </div>
    </div>
  </template>

  <script>
    /**
     * `drag-resize`
     * A touch friendly resizable container with resize events.
     *
     * @customElement
     * @polymer
     * @demo demo/index.html
     */
    class DragResize extends Polymer.GestureEventListeners(Polymer.Element) {
      static get is() { return 'drag-resize'; }
      static get properties() {
        return {
          /**
           * Which edges allow resize.
           * Any combination of `top`, `left`, `bottom`, `right`.
           */
          edges: {
            type: String,
            value: 'bottom right top left',
            observer: '_edgesChanged'
          },
        };
      }

      // connectedCallback() {
      //   super.connectedCallback();
      //   this._observer = new Polymer.FlattenedNodesObserver(function(info) {
      //     // info is {addedNodes: [...], removedNodes: [...]}
      //     console.log('nodes', info);
      //     this.box = this._getContents;
      //   });
      // }
      // disconnectedCallback() {
      //   super.disconnectedCallback();
      //   this._observer.disconnect();
      // }

      _getContents() {
        return this.shadowRoot.querySelector('slot').assignedNodes({flatten:true})
          .filter(n => n.nodeType === Node.ELEMENT_NODE)[0];
      }

      _edgesChanged(edges) {
        if (typeof edges != 'string') return;
        this.top = edges.includes('top');
        this.bottom = edges.includes('bottom');
        this.left = edges.includes('left');
        this.right = edges.includes('right');
        this.topLeft = this.top && this.left;
        this.topRight = this.top && this.right;
        this.bottomLeft = this.bottom && this.left;
        this.bottomRight = this.bottom && this.right;
      }

      _onTrack(e, track) {
        this.box = this._getContents();
        let dx = Math.round(track.ddx || 0);
        let dy = Math.round(track.ddy || 0);
        // if (track.state == 'start') {
          // console.log('resizing', e.target.id, this.box);
        // }

        if (this._prevTop === undefined) {
          this._prevTop = this.box.offsetTop || 0;
        }
        if (this._prevLeft === undefined) {
          this._prevLeft = this.box.offsetLeft || 0;
        }

        let top = this._prevTop;
        let left = this._prevLeft;
        let height = this.box.offsetHeight;
        let width = this.box.offsetWidth;

        let translate = this._sidesToTranslate(this.box);

        if (e.target.id.includes('top')) {
          height += -dy || 0;
          if (height < 0) height = 0;
          else top += translate.top ? dy : 0;
        } else if (e.target.id.includes('bottom')) {
          height += dy || 0;
          if (height < 0) height = 0;
          else top += translate.bottom ? -dy : 0;
        }

        if (e.target.id.toLowerCase().includes('left')) {
          width += -dx || 0;
          if (width < 0) width = 0;
          else left += translate.left ? dx : 0;
        } else if (e.target.id.toLowerCase().includes('right')) {
          width += dx || 0;
          if (width < 0) width = 0;
          else left += translate.right ? dx : 0;
        }

        this.box.offsetParent.style.transform = `translate(${left}px, ${top}px)`;
        this.box.style.height = height + 'px';
        this.box.style.width = width + 'px';

        if (track.state == 'end') {
          console.log(e.target.id, 'moved', track, [this.box]);
        }

        this._fire('resize', track);
        this._prevTop = top;
        this._prevLeft = left;
      }

      _sidesToTranslate(element) {
        let top = element.offsetParent.offsetTop;
        let left = element.offsetParent.offsetLeft;
        element.style.height = (element.offsetHeight + 1) + 'px';
        element.style.width = (element.offsetWidth + 1) + 'px';
        let translateTop = element.offsetParent.offsetTop == top;
        let translateLeft = element.offsetParent.offsetLeft == left;
        return {
          top: translateTop,
          left:translateLeft,
          bottom: !translateTop,
          right: !translateLeft
        };
      }

      /** Copy the Polymer 1.x fire implementation. */
      _fire(name, data, options = {}) {
        options.detail = data;
        if (options.bubbles === undefined) options.bubbles = true;
        if (options.composed === undefined) options.composed = true;
        this.dispatchEvent(new CustomEvent(name, options));
      }

      /**
       * Triggered when the element is resized.
       * @event resize
       * @param {track} object The on-track event detail.
       */
    }

    window.customElements.define(DragResize.is, DragResize);
  </script>
</dom-module>
